<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å®å®å¿«ä¹å™¨ - ä¿®å¤ç‰ˆ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); padding-bottom: 200px; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ff5e62; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; }
        .login-box input { padding: 12px; font-size: 1.1rem; border: 2px solid #eee; border-radius: 10px; margin-bottom: 15px; width: 100%; outline: none; box-sizing: border-box; }
        .btn-login { background: #ff5e62; color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%; }
        
        .leaderboard { width: 85vw; max-width: 380px; background: white; border-radius: 15px; margin-top: 20px; padding: 15px; border: 2px solid #fff5f5; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #fceaea; }
        
        .wheel-wrapper { position: relative; width: 85vw; height: 85vw; max-width: 380px; max-height: 380px; margin: 10px auto; }
        canvas { width: 100%; height: 100%; border-radius: 50%; }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 35px; height: 45px; background: #ff4757; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10; }
        .btn-start { padding: 12px 50px; font-size: 1.4rem; background: #2ed573; color: white; border: none; border-radius: 50px; margin-top: 10px; cursor: pointer; }
        
        #debugConsole {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace;
            font-size: 11px; overflow-y: scroll; padding: 10px; box-sizing: border-box;
            z-index: 9999; text-align: left; pointer-events: none;
        }
        .log-error { color: #ff5e62; font-weight: bold; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; text-align: center; width: 80%; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: #ff5e62">ä½ æ˜¯è°ï¼Ÿ</h2>
            <input type="text" id="userNameInput" placeholder="è¾“å…¥ä½ çš„åå­—">
            <button class="btn-login" onclick="checkLogin()">å¼€å¯å¿«ä¹</button>
            <div id="networkTip" style="margin-top:10px; font-size:12px; color:#666;">ç›´è¿æ¨¡å¼å°±ç»ª</div>
        </div>
    </div>

    <h1>å°å®å®å¿«ä¹å™¨</h1>
    <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:10px; text-align:center;">
        <div id="welcomeText" style="font-weight:bold;"></div>
        <div id="todayStatus" style="font-size:12px; color:#666;">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div class="wheel-wrapper">
        <div class="pointer"></div>
        <canvas id="wheelCanvas" width="800" height="800"></canvas>
    </div>
    <button class="btn-start" onclick="startSpin()" id="spinBtn">ç‚¹å‡»å¼€å§‹</button>

    <div class="leaderboard">
        <h3 style="color:#ff5e62; text-align:center; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ¶ å®æ—¶æˆ˜å†µ</h3>
        <div id="rankList" style="text-align:center; font-size:12px; color:#999;">åŠ è½½ä¸­...</div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <h2 id="prizeText" style="color:#ff4757; font-size:2rem;"></h2>
            <div id="uploadTip" style="font-size:12px; color:#999;"></div>
            <button onclick="closeModal()" style="margin-top:10px; padding:10px 30px; background:#ff5e62; color:white; border:none; border-radius:20px;">æ”¶ä¸‹</button>
        </div>
    </div>

    <div id="debugConsole"><div>>>> ç³»ç»Ÿå¯åŠ¨: ä¿®å¤400é”™è¯¯ç‰ˆ</div></div>

    <script>
        function log(msg, type) {
            const box = document.getElementById('debugConsole');
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type) d.className = 'log-error';
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        // âœ… å·²å¡«å¥½ä½ çš„ ID å’Œ Key
        const APP_ID = '46665cb4f873b9c33d508dbe48682e4b';
        const REST_KEY = '9837d091aafcf90ccb396f1e9a75929a';

        // ğŸš€ æ”¹è¿›çš„è¯·æ±‚å‡½æ•°ï¼šä¿®å¤ 400 é”™è¯¯
        async function callBmob(method, endpoint, data) {
            const url = `https://api.bmobcloud.com/1/classes/${endpoint}` + (method === 'GET' && data ? '?' + new URLSearchParams(data) : '');
            
            const headers = {
                'X-Bmob-Application-Id': APP_ID,
                'X-Bmob-REST-API-Key': REST_KEY
            };
            // âš ï¸ å…³é”®ä¿®æ”¹ï¼šåªæœ‰ POST æ‰åŠ  Content-Typeï¼Œé˜²æ­¢ GET æŠ¥ 400 é”™è¯¯
            if (method === 'POST') {
                headers['Content-Type'] = 'application/json';
            }

            const options = { method: method, headers: headers };
            if (method === 'POST') options.body = JSON.stringify(data);

            try {
                const res = await fetch(url, options);
                if (!res.ok) {
                    // è¯»å–å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                    const errText = await res.text();
                    throw new Error(`Code ${res.status}: ${errText}`);
                }
                return await res.json();
            } catch (e) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${e.message}`, true);
                throw e;
            }
        }

        const ALLOWED_NAMES = ['å‰å‰', 'å°æ±Ÿ', 'è®¿å®¢'];
        let currentUser = "";

        // æµ‹è¯•è¿æ¥
        window.onload = function() {
            log("æ­£åœ¨æµ‹è¯•è¿æ¥...");
            callBmob('GET', 'Leaderboard', { limit: 1 }).then(() => {
                log("âœ… è¿æ¥æˆåŠŸï¼");
                document.getElementById('networkTip').innerHTML = "<span style='color:green'>âœ… ç½‘ç»œé€šç•…</span>";
            }).catch(e => {
                log("è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å·²åœ¨åå°æ¸…ç©ºå®‰å…¨ç ", true);
                document.getElementById('networkTip').innerHTML = "<span style='color:red'>âš ï¸ è¿æ¥å—é˜»ï¼Œè¯·çœ‹ä¸‹æ–¹æŠ¥é”™</span>";
            });
        }

        function checkLogin() {
            const name = document.getElementById('userNameInput').value.trim();
            if (ALLOWED_NAMES.includes(name)) {
                currentUser = name;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('welcomeText').innerText = `ä½ å¥½å‘€ï¼Œ${currentUser}ï¼`;
                fetchData();
            } else {
                alert("æš—å·ä¸å¯¹ï¼");
            }
        }

        function fetchData() {
            log("æ­£åœ¨åˆ·æ–°æ¦œå•...");
            const today = new Date().toLocaleDateString();
            const params = { where: JSON.stringify({ "dateKey": today }), order: "-createdAt" };

            callBmob('GET', 'Leaderboard', params).then(res => {
                const list = res.results || [];
                log(`âœ… è·å–åˆ° ${list.length} æ¡æ•°æ®`);
                renderList(list);
                const my = list.find(i => i.name === currentUser);
                document.getElementById('todayStatus').innerText = my ? `ä»Šæ—¥æˆ˜ç»©: ${my.prize}` : "ä»Šæ—¥æš‚æœªæŠ½å¥–";
            }).catch(() => {
                document.getElementById('todayStatus').innerText = "è·å–å¤±è´¥";
            });
        }

        function renderList(list) {
            const box = document.getElementById('rankList');
            if(!list.length) { box.innerText = "ä»Šæ—¥æ¦œå•è™šä½ä»¥å¾…..."; return; }
            box.innerHTML = list.map((item, i) => `
                <div class="rank-item">
                    <span>${i+1}. ${item.name}</span>
                    <span style="color:#ff4757;font-weight:bold">${item.prize}</span>
                </div>
            `).join('');
        }

        function uploadScore(prize) {
            if(prize === "å†æ¥ä¸€æ¬¡") return;
            log(`æ­£åœ¨ä¿å­˜: ${prize}...`);
            const today = new Date().toLocaleDateString();
            
            // æŸ¥é‡
            callBmob('GET', 'Leaderboard', { where: JSON.stringify({ "dateKey": today, "name": currentUser }) }).then(res => {
                if (res.results && res.results.length > 0) {
                    log("âš ï¸ ä»Šå¤©å·²ç»ç©è¿‡äº†");
                    document.getElementById('uploadTip').innerText = "ä»Šæ—¥å·²è®°å½•ï¼Œä¸å†é‡å¤ä¸Šä¼ ";
                } else {
                    // ä¸Šä¼ 
                    callBmob('POST', 'Leaderboard', {
                        name: currentUser, prize: prize, dateKey: today, timeStr: new Date().toLocaleTimeString()
                    }).then(() => {
                        log("âœ… ä¿å­˜æˆåŠŸï¼");
                        document.getElementById('uploadTip').innerText = "æˆ˜ç»©å·²åŒæ­¥äº‘ç«¯";
                        fetchData();
                    });
                }
            });
        }

        // æŠ½å¥–åŠ¨ç”»é€»è¾‘
        const prizes = [
            { name: "äº²ä¸€å£", weight: 12, color: "#FF9F43" },
            { name: "å†æ¥ä¸€æ¬¡", weight: 15, color: "#54a0ff" },
            { name: "å¥–é‡‘50", weight: 15, color: "#2ed573" },
            { name: "å¥–é‡‘30", weight: 15, color: "#1dd1a1" },
            { name: "å¥–é‡‘100", weight: 25, color: "#ff4757" }, 
            { name: "å¥–é‡‘200", weight: 6, color: "#5f27cd" }, 
            { name: "å¥–é‡‘5å…ƒ", weight: 6, color: "#a29bfe" },  
            { name: "å˜»å˜»å˜»", weight: 6, color: "#fd79a8" }    
        ];
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const totalWeight = prizes.reduce((s, p) => s + p.weight, 0);
        let rotation = 0;

        function draw() {
            const R = canvas.width / 2;
            let start = -Math.PI/2;
            prizes.forEach(p => {
                const angle = (p.weight/totalWeight) * 2 * Math.PI;
                ctx.beginPath(); ctx.moveTo(R,R); ctx.arc(R,R,R,start,start+angle);
                ctx.fillStyle = p.color; ctx.fill(); ctx.stroke();
                ctx.save(); ctx.translate(R,R); ctx.rotate(start+angle/2);
                ctx.textAlign="right"; ctx.fillStyle="#fff"; ctx.font="bold 40px Arial";
                ctx.fillText(p.name, R-30, 10); ctx.restore();
                start += angle;
            });
        }
        draw();

        function startSpin() {
            const btn = document.getElementById('spinBtn');
            if(btn.disabled) return;
            btn.disabled = true;
            const rand = Math.random() * totalWeight;
            let sum = 0, target = prizes[0];
            for(let p of prizes) { sum += p.weight; if(rand <= sum) { target = p; break; } }
            
            let prevSum = 0;
            for(let p of prizes) { if(p===target) break; prevSum += p.weight; }
            const targetAngle = (prevSum + target.weight/2) / totalWeight * 360;
            const dist = 360*5 + (360 - targetAngle) - (rotation%360);
            rotation += dist;
            canvas.style.transform = `rotate(${rotation}deg)`;
            canvas.style.transition = "transform 4s cubic-bezier(0.2,0.8,0.2,1)";

            setTimeout(() => {
                document.getElementById('prizeText').innerText = target.name;
                document.getElementById('modalOverlay').classList.add('active');
                uploadScore(target.name);
            }, 4000);
        }
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('spinBtn').disabled = false;
        }
    </script>
</body>
</html>