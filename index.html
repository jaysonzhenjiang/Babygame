<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026å°å®å®å¿«ä¹å™¨ - æƒ…äººèŠ‚ç‰¹ä¾›</title>
    <style>
        /* --- 1. æƒ…äººèŠ‚æ°›å›´æµªæ¼«æ ·å¼ --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; 
            /* æµªæ¼«ç²‰çº¢æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); 
            padding-bottom: 200px; 
            color: #fff;
            overflow-x: hidden;
        }

        /* æ¼‚æµ®è£…é¥° - å¢åŠ æƒ…äººèŠ‚å…ƒç´  */
        .deco { position: fixed; font-size: 2rem; opacity: 0.4; z-index: 0; animation: float 6s infinite ease-in-out; pointer-events: none; }
        @keyframes float { 0%,100%{transform:translateY(0) rotate(0deg);} 50%{transform:translateY(-20px) rotate(10deg);} }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 117, 140, 0.95); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        
        .login-box { 
            background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; 
            border: 4px solid #ff7eb3; /* æµªæ¼«ç²‰è¾¹ */
            box-shadow: 0 10px 30px rgba(255, 117, 140, 0.4);
        }
        .login-box h2 { color: #ff4757; margin-top: 0; }
        .login-box input { padding: 12px; font-size: 1.1rem; border: 2px solid #ffeaa7; border-radius: 10px; margin-bottom: 15px; width: 100%; outline: none; box-sizing: border-box; color: #333; }
        .login-box input:focus { border-color: #ff7eb3; }
        
        .btn-login { background: linear-gradient(45deg, #ff758c, #ff7eb3); color: #fff; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1.1rem; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(255, 117, 140, 0.4); }
        .btn-login:active { transform: scale(0.95); }
        
        .leaderboard { 
            width: 85vw; max-width: 380px; 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 15px; margin-top: 20px; padding: 15px; 
            border: 2px solid #ff7eb3; 
            color: #333;
            box-shadow: 0 8px 20px rgba(255, 117, 140, 0.2);
        }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ffb8b8; }
        
        /* è½¬ç›˜æ ·å¼ä¼˜åŒ– - æƒ…äººèŠ‚é…è‰² */
        .wheel-wrapper { 
            position: relative; width: 85vw; height: 85vw; max-width: 380px; max-height: 380px; margin: 20px auto; 
            background: #fff; /* ç™½è¾¹åº•ç›˜ */
            padding: 8px;
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(255, 71, 87, 0.3);
        }
        canvas { width: 100%; height: 100%; border-radius: 50%; display: block; }
        
        .pointer { 
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%); 
            width: 40px; height: 50px; 
            background: #ff4757; 
            border: 3px solid #fff;
            clip-path: polygon(50% 100%, 0 0, 100% 0); 
            z-index: 10; 
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2));
        }

        /* --- 3. äº¤äº’åŠ¨ç”» --- */
        .btn-start { 
            padding: 15px 60px; font-size: 1.5rem; 
            background: linear-gradient(to bottom, #ff7eb3, #ff758c); /* ç²‰çº¢æŒ‰é’® */
            color: #fff; font-weight: bold; 
            border: 2px solid #fff; border-radius: 50px; 
            margin-top: 15px; cursor: pointer; 
            box-shadow: 0 5px 0 #d63031, 0 10px 15px rgba(255, 71, 87, 0.3);
            transition: all 0.1s;
            animation: pulse 2s infinite;
        }
        .btn-start:active { transform: translateY(5px); box-shadow: 0 0 0 #d63031; }
        .btn-start:disabled { background: #ccc; color: #666; box-shadow: none; animation: none; cursor: not-allowed; border-color:#ccc; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        #debugConsole {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.6); color: #0f0; font-family: monospace;
            font-size: 10px; overflow-y: scroll; padding: 10px; box-sizing: border-box;
            z-index: 9999; text-align: left; pointer-events: none;
            display: none; 
        }
        .log-error { color: #ff5e62; font-weight: bold; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; }
        .modal-content { 
            /* æ›¿æ¢ä¸ºçˆ±å¿ƒå›¾æ ‡ */
            background: #fff url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><text y="50" font-size="20">ğŸ’–</text></svg>');
            padding: 30px; border-radius: 20px; text-align: center; width: 80%; color: #333; 
            border: 4px solid #ff7eb3;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* æ’’èŠ±ç‰¹æ•ˆç²’å­ */
        .confetti { position: fixed; width: 12px; height: 12px; z-index: 2001; animation: fall linear forwards; border-radius: 50%; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    </style>
</head>
<body>

    <div class="deco" style="top:5%; left:5%">ğŸ’–</div>
    <div class="deco" style="top:15%; right:5%; animation-delay:1s">ğŸŒ¹</div>
    <div class="deco" style="bottom:10%; left:10%; animation-delay:2s">ğŸ´</div>
    <div class="deco" style="bottom:20%; right:10%; animation-delay:3s">ğŸ’Œ</div>
    <div class="deco" style="top:40%; left:8%; animation-delay:1.5s">âœ¨</div>
    <div class="deco" style="bottom:40%; right:8%; animation-delay:2.5s">ğŸ’</div>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>ğŸ´ ä½ æ˜¯ä»€ä¹ˆç‹—ç²‘ç²‘</h2>
            <input type="text" id="userNameInput" placeholder="ç‹—ç²‘ç²‘">
            <button class="btn-login" onclick="checkLogin()">å¼€å¯å¿ƒåŠ¨ç‰¹ä¾›</button>
            <div id="networkTip" style="margin-top:10px; font-size:12px; color:#666;">æœåŠ¡å™¨è¿æ¥ä¸­...</div>
        </div>
    </div>

    <h1 style="text-shadow: 2px 2px 4px rgba(255,71,87,0.4); margin-bottom: 10px; color: #fff;">2026é©¬åˆ°æˆåŠŸ</h1>
    <div style="background:rgba(255,255,255,0.9); padding:10px 20px; border-radius:20px; text-align:center; color:#ff4757; box-shadow: 0 4px 10px rgba(255,117,140,0.2);">
        <div id="welcomeText" style="font-weight:bold; font-size: 1.1rem;"></div>
        <div id="todayStatus" style="font-size:12px; color:#666; margin-top:4px;">ç­‰å¾…çˆ±æ„é™ä¸´...</div>
    </div>

    <div class="wheel-wrapper">
        <div class="pointer"></div>
        <canvas id="wheelCanvas" width="800" height="800"></canvas>
    </div>
    
    <button class="btn-start" onclick="startSpin()" id="spinBtn">æŠ½å–å¿ƒåŠ¨</button>

    <div class="leaderboard">
        <h3 style="color:#ff4757; text-align:center; border-bottom:1px solid #ffb8b8; padding-bottom:5px; margin:0 0 10px 0;">ğŸ† ä»Šæ—¥çº¢æ¦œ</h3>
        <div id="rankList" style="text-align:center; font-size:12px; color:#666;">åŠ è½½ä¸­...</div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <h3 style="color:#999; margin:0;">æµªæ¼«é”å®šï¼Œæ­å–œè·å¾—</h3>
            <h2 id="prizeText" style="color:#ff4757; font-size:2.5rem; margin: 10px 0;"></h2>
            <div id="uploadTip" style="font-size:12px; color:#999;"></div>
            <button onclick="closeModal()" style="margin-top:20px; padding:12px 40px; background:#ff4757; color:white; border:none; border-radius:25px; font-size:1.2rem; cursor:pointer; box-shadow: 0 4px 10px rgba(255,71,87,0.3);">å¼€å¿ƒæ”¶ä¸‹</button>
        </div>
    </div>

    <div id="debugConsole"><div>>>> ç³»ç»Ÿå¯åŠ¨: æƒ…äººèŠ‚ç‰¹ä¾›ç‰ˆ</div></div>

    <script>
        function log(msg, type) {
            const box = document.getElementById('debugConsole');
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type) d.className = 'log-error';
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        const APP_ID = '46665cb4f873b9c33d508dbe48682e4b';
        const REST_KEY = '9837d091aafcf90ccb396f1e9a75929a';

        async function callBmob(method, endpoint, data) {
            const url = `https://api.bmobcloud.com/1/classes/${endpoint}` + (method === 'GET' && data ? '?' + new URLSearchParams(data) : '');
            const headers = {
                'X-Bmob-Application-Id': APP_ID,
                'X-Bmob-REST-API-Key': REST_KEY
            };
            if (method === 'POST') headers['Content-Type'] = 'application/json';
            const options = { method: method, headers: headers };
            if (method === 'POST') options.body = JSON.stringify(data);

            try {
                const res = await fetch(url, options);
                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`Code ${res.status}: ${errText}`);
                }
                return await res.json();
            } catch (e) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${e.message}`, true);
                throw e;
            }
        }

        const ALLOWED_NAMES = ['å‰å‰', 'å°æ±Ÿ', 'è®¿å®¢'];
        let currentUser = "";

        window.onload = function() {
            log("æ­£åœ¨æµ‹è¯•è¿æ¥...");
            callBmob('GET', 'Leaderboard', { limit: 1 }).then(() => {
                log("âœ… è¿æ¥æˆåŠŸï¼");
                document.getElementById('networkTip').innerHTML = "<span style='color:#e84393'>âœ… ç½‘ç»œé€šç•…ï¼Œå‡†å¤‡å¿ƒåŠ¨</span>";
            }).catch(e => {
                document.getElementById('networkTip').innerHTML = "<span style='color:red'>âš ï¸ ç½‘ç»œä¸ç»™åŠ›</span>";
            });
        }

        function checkLogin() {
            const name = document.getElementById('userNameInput').value.trim();
            if (ALLOWED_NAMES.includes(name)) {
                currentUser = name;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('welcomeText').innerText = `ğŸ´ ${currentUser}ï¼Œæƒ…äººèŠ‚å¿«ä¹ï¼`;
                fetchData();
            } else {
                alert("ä½ ä¸æ˜¯æˆ‘å®¶çš„ç‹—ç²‘ç²‘ï¼");
            }
        }

        function fetchData() {
             const today = new Date().toLocaleDateString();
             const params = { where: JSON.stringify({ "dateKey": today }), order: "-createdAt", limit: 500 }; 
            
             callBmob('GET', 'Leaderboard', params).then(res => {
                 const list = res.results || [];
                 renderList(list);
                
                 const my = list.find(i => i.name === currentUser);
                 document.getElementById('todayStatus').innerText = my ? `æœ€æ–°æˆ˜ç»©: ${my.prize}` : "ä»Šæ—¥æµªæ¼«è¿˜æ²¡å¼€å¯";
             });
         }

        function getMoneyValue(str) {
            if(!str) return 0;
            const num = str.match(/\d+/);
            return num ? parseInt(num[0]) : 0;
        }

        function renderList(list) {
            const box = document.getElementById('rankList');
            if(!list.length) { box.innerText = "ä»Šæ—¥æ¦œå•è™šä½ä»¥å¾…ï¼Œå¿«æ¥æ‹¿ç¬¬ä¸€ï¼"; return; }

            let moneyList = [];
            let otherList = [];

            list.forEach(item => {
                const val = getMoneyValue(item.prize);
                if (val > 0) {
                    item._val = val; 
                    moneyList.push(item);
                } else {
                    otherList.push(item);
                }
            });

            moneyList.sort((a, b) => b._val - a._val);
            
            let html = "";

            if (moneyList.length > 0) {
                html += `<div style="background:#fff0f5; padding:5px; border-radius:5px; margin-bottom:10px; font-weight:bold; color:#ff4757;">ğŸ’ å® çˆ±æ¦œ</div>`;
                html += moneyList.map((item, i) => {
                    let icon = i === 0 ? 'ğŸ¥‡' : (i === 1 ? 'ğŸ¥ˆ' : (i === 2 ? 'ğŸ¥‰' : `${i+1}.`));
                    return `
                    <div class="rank-item">
                        <span>${icon} ${item.name}</span>
                        <span style="color:#ff4757; font-weight:bold">${item.prize}</span>
                    </div>`;
                }).join('');
            }

            if (otherList.length > 0) {
                html += `<div style="background:#f0f3f5; padding:5px; border-radius:5px; margin-top:15px; margin-bottom:10px; font-weight:bold; color:#7f8c8d;">ğŸ­ æ°”æ°›ç»„</div>`;
                html += otherList.map((item) => `
                    <div class="rank-item" style="color:#999;">
                        <span>${item.name}</span>
                        <span>${item.prize}</span>
                    </div>
                `).join('');
            }

            box.innerHTML = html;
        }

        function uploadScore(prize) {
            if(prize.includes("å†æ¥") || prize.includes("æ–°å¹´")) return; 
            
            const today = new Date().toLocaleDateString();
            callBmob('GET', 'Leaderboard', { where: JSON.stringify({ "dateKey": today, "name": currentUser }) }).then(res => {
                if (res.results && res.results.length > 0) {
                    document.getElementById('uploadTip').innerText = "ä»Šæ—¥å·²è®°å½•ï¼Œä¸å†é‡å¤ä¸Šä¼ ";
                } else {
                    callBmob('POST', 'Leaderboard', {
                        name: currentUser, prize: prize, dateKey: today, timeStr: new Date().toLocaleTimeString()
                    }).then(() => {
                        document.getElementById('uploadTip').innerText = "æµªæ¼«æˆ˜ç»©å·²åŒæ­¥äº‘ç«¯";
                        fetchData();
                    });
                }
            });
        }

        // --- 2. æ¦‚ç‡ä¸å¥–å“é€»è¾‘è°ƒæ•´ (ä¸¥æ ¼æŒ‰ç…§ä½ çš„è¦æ±‚é…ç½®) ---
        // weight: ä¸­å¥–æ¦‚ç‡ã€‚æ€»å’Œ100ï¼Œåˆ†åˆ«å¯¹åº” 15%, 10%, 60%, 5%, 10%
        // drawWeight: è½¬ç›˜ä¸Šçš„è§†è§‰å æ¯”é¢ç§¯ã€‚è®¾ç½®ä¸º 1 ä»£è¡¨äº”ç­‰åˆ†ï¼Œçœ‹èµ·æ¥æœ€èˆ’æœã€‚
        const prizes = [
            { name: "666å…ƒ", weight: 15, drawWeight: 1, color: "#ff758c", txtColor: "#fff" },   
            { name: "999å…ƒ", weight: 10, drawWeight: 1, color: "#ff9a9e", txtColor: "#fff" },  
            { name: "520å…ƒ", weight: 60, drawWeight: 1, color: "#ff4757", txtColor: "#fff" },   
            { name: "1314å…ƒ", weight: 5, drawWeight: 1, color: "#e84393", txtColor: "#fff" },   
            { name: "521å…ƒ", weight: 10, drawWeight: 1, color: "#ffb8b8", txtColor: "#d63031" } 
        ];

        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        
        const totalProbabilityWeight = prizes.reduce((s, p) => s + p.weight, 0); // 100
        const totalDrawWeight = prizes.reduce((s, p) => s + p.drawWeight, 0); 

        let rotation = 0;

        function draw() {
            const R = canvas.width / 2;
            let start = -Math.PI/2;
            
            prizes.forEach(p => {
                const angle = (p.drawWeight / totalDrawWeight) * 2 * Math.PI;
                
                ctx.beginPath(); ctx.moveTo(R,R); ctx.arc(R,R,R,start,start+angle);
                ctx.fillStyle = p.color; ctx.fill(); 
                ctx.lineWidth = 4; ctx.strokeStyle = "#fff"; ctx.stroke();
                
                ctx.save(); ctx.translate(R,R); ctx.rotate(start+angle/2);
                ctx.textAlign="right"; 
                ctx.fillStyle = p.txtColor || "#fff"; 
                ctx.font="bold 40px -apple-system, sans-serif"; 
                ctx.fillText(p.name, R-40, 15); 
                ctx.restore();
                start += angle;
            });
        }
        draw();

        function startSpin() {
            const btn = document.getElementById('spinBtn');
            if(btn.disabled) return;
            btn.disabled = true;
            btn.innerText = "å¿ƒåŠ¨æµè½¬ä¸­...";
            
            // æŠ½å¥–é€»è¾‘
            const rand = Math.random() * totalProbabilityWeight;
            let sum = 0, target = prizes[0];
            for(let p of prizes) { sum += p.weight; if(rand <= sum) { target = p; break; } }
            
            // æ—‹è½¬è§’åº¦è®¡ç®—
            let prevDrawSum = 0;
            for(let p of prizes) { if(p===target) break; prevDrawSum += p.drawWeight; }
            
            const targetAngle = (prevDrawSum + target.drawWeight/2) / totalDrawWeight * 360;
            const dist = 360*6 + (360 - targetAngle) - (rotation%360); // è½¬6åœˆ
            rotation += dist;
            
            canvas.style.transform = `rotate(${rotation}deg)`;
            canvas.style.transition = "transform 5s cubic-bezier(0.2,0.8,0.1,1)"; 

            setTimeout(() => {
                document.getElementById('prizeText').innerText = target.name;
                document.getElementById('modalOverlay').classList.add('active');
                
                fireConfetti();
                uploadScore(target.name);
                btn.innerText = "å†æ¬¡å¿ƒåŠ¨";
            }, 5000);
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('spinBtn').disabled = false;
        }

        // --- æµªæ¼«æ’’èŠ±ç‰¹æ•ˆ ---
        function fireConfetti() {
            // æƒ…äººèŠ‚æµªæ¼«é…è‰²
            const colors = ['#ff758c', '#ff4757', '#ffb8b8', '#fff', '#e84393'];
            for(let i=0; i<60; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.background = colors[Math.floor(Math.random()*colors.length)];
                c.style.left = Math.random()*100 + 'vw';
                c.style.top = -20 + 'px';
                // å¢åŠ å¤§å°éšæœºå˜åŒ–
                const size = Math.random() * 8 + 6;
                c.style.width = size + 'px';
                c.style.height = size + 'px';
                c.style.animationDuration = (Math.random()*2 + 1.5) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3500);
            }
        }
    </script>
</body>
</html>