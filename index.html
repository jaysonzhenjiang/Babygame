<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026é©¬å¹´å¿«ä¹å™¨ - æ–°æ˜¥ç‰ˆ</title>
    <style>
        /* --- 1. 2026 æ–°å¹´æ°›å›´æ ·å¼ --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; 
            /* æ–°å¹´çº¢èƒŒæ™¯ */
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); 
            padding-bottom: 200px; 
            color: #fff;
            overflow-x: hidden;
        }

        /* æ¼‚æµ®è£…é¥° */
        .deco { position: fixed; font-size: 2rem; opacity: 0.2; z-index: 0; animation: float 6s infinite ease-in-out; pointer-events: none; }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-20px);} }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #e74c3c; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .login-box { 
            background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; 
            border: 4px solid #f1c40f; /* é‡‘è¾¹ */
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .login-box h2 { color: #c0392b; margin-top: 0; }
        .login-box input { padding: 12px; font-size: 1.1rem; border: 2px solid #eee; border-radius: 10px; margin-bottom: 15px; width: 100%; outline: none; box-sizing: border-box; color: #333; }
        
        .btn-login { background: #c0392b; color: #f1c40f; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1.1rem; transition: transform 0.2s; }
        .btn-login:active { transform: scale(0.95); }
        
        .leaderboard { 
            width: 85vw; max-width: 380px; 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 15px; margin-top: 20px; padding: 15px; 
            border: 2px solid #f1c40f; /* é‡‘è¾¹ */
            color: #333;
        }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #fab1a0; }
        
        /* è½¬ç›˜æ ·å¼ä¼˜åŒ– */
        .wheel-wrapper { 
            position: relative; width: 85vw; height: 85vw; max-width: 380px; max-height: 380px; margin: 20px auto; 
            background: #f1c40f; /* é‡‘è‰²åº•ç›˜ */
            padding: 5px;
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        canvas { width: 100%; height: 100%; border-radius: 50%; display: block; }
        
        .pointer { 
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%); 
            width: 40px; height: 50px; 
            background: #e74c3c; 
            border: 2px solid #fff;
            clip-path: polygon(50% 100%, 0 0, 100% 0); 
            z-index: 10; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }

        /* --- 3. äº¤äº’åŠ¨ç”» --- */
        .btn-start { 
            padding: 15px 60px; font-size: 1.5rem; 
            background: linear-gradient(to bottom, #f1c40f, #f39c12); /* é‡‘è‰²æŒ‰é’® */
            color: #d35400; font-weight: bold; 
            border: 2px solid #fff; border-radius: 50px; 
            margin-top: 15px; cursor: pointer; 
            box-shadow: 0 5px 0 #d35400, 0 10px 10px rgba(0,0,0,0.2);
            transition: all 0.1s;
            animation: pulse 2s infinite;
        }
        .btn-start:active { transform: translateY(5px); box-shadow: 0 0 0 #d35400; }
        .btn-start:disabled { background: #ccc; color: #666; box-shadow: none; animation: none; cursor: not-allowed; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        #debugConsole {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.6); color: #0f0; font-family: monospace;
            font-size: 10px; overflow-y: scroll; padding: 10px; box-sizing: border-box;
            z-index: 9999; text-align: left; pointer-events: none;
            display: none; /* é»˜è®¤éšè—ï¼Œçœ‹èµ·æ¥æ›´å¹²å‡€ */
        }
        .log-error { color: #ff5e62; font-weight: bold; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal-content { 
            background: #fff url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><text y="50" font-size="20">ğŸ§§</text></svg>');
            padding: 30px; border-radius: 20px; text-align: center; width: 80%; color: #333; 
            border: 4px solid #f1c40f;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* æ’’èŠ±ç‰¹æ•ˆç²’å­ */
        .confetti { position: fixed; width: 10px; height: 10px; z-index: 2001; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    </style>
</head>
<body>

    <div class="deco" style="top:5%; left:5%">ğŸ®</div>
    <div class="deco" style="top:15%; right:5%; animation-delay:1s">ğŸ§¨</div>
    <div class="deco" style="bottom:10%; left:10%; animation-delay:2s">ğŸ´</div>
    <div class="deco" style="bottom:20%; right:10%; animation-delay:3s">ğŸ’°</div>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>ğŸ´ ä½ æ˜¯ä»€ä¹ˆç‹—ç²‘ç²‘</h2>
            <input type="text" id="userNameInput" placeholder="ç‹—ç²‘ç²‘">
            <button class="btn-login" onclick="checkLogin()">å¼€å¯é¸¿è¿</button>
            <div id="networkTip" style="margin-top:10px; font-size:12px; color:#666;">æœåŠ¡å™¨è¿æ¥ä¸­...</div>
        </div>
    </div>

    <h1 style="text-shadow: 2px 2px 0 rgba(0,0,0,0.2); margin-bottom: 10px;">2026é©¬åˆ°æˆåŠŸ</h1>
    <div style="background:rgba(255,255,255,0.9); padding:10px 20px; border-radius:20px; text-align:center; color:#c0392b; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div id="welcomeText" style="font-weight:bold; font-size: 1.1rem;"></div>
        <div id="todayStatus" style="font-size:12px; color:#666; margin-top:4px;">ç­‰å¾…å¥½è¿...</div>
    </div>

    <div class="wheel-wrapper">
        <div class="pointer"></div>
        <canvas id="wheelCanvas" width="800" height="800"></canvas>
    </div>
    
    <button class="btn-start" onclick="startSpin()" id="spinBtn">ç«‹å³è½¬è¿</button>

    <div class="leaderboard">
        <h3 style="color:#c0392b; text-align:center; border-bottom:1px solid #fab1a0; padding-bottom:5px; margin:0 0 10px 0;">ğŸ† ä»Šæ—¥çº¢æ¦œ</h3>
        <div id="rankList" style="text-align:center; font-size:12px; color:#666;">åŠ è½½ä¸­...</div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <h3 style="color:#999; margin:0;">æ­å–œè·å¾—</h3>
            <h2 id="prizeText" style="color:#e74c3c; font-size:2.5rem; margin: 10px 0;"></h2>
            <div id="uploadTip" style="font-size:12px; color:#999;"></div>
            <button onclick="closeModal()" style="margin-top:20px; padding:12px 40px; background:#e74c3c; color:white; border:none; border-radius:25px; font-size:1.2rem; cursor:pointer;">å¼€å¿ƒæ”¶ä¸‹</button>
        </div>
    </div>

    <div id="debugConsole"><div>>>> ç³»ç»Ÿå¯åŠ¨: 2026æ–°æ˜¥ç‰¹åˆ«ç‰ˆ</div></div>

    <script>
        function log(msg, type) {
            const box = document.getElementById('debugConsole');
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type) d.className = 'log-error';
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        // Bmob Config (ä¿æŒåŸæ ·)
        const APP_ID = '46665cb4f873b9c33d508dbe48682e4b';
        const REST_KEY = '9837d091aafcf90ccb396f1e9a75929a';

        async function callBmob(method, endpoint, data) {
            const url = `https://api.bmobcloud.com/1/classes/${endpoint}` + (method === 'GET' && data ? '?' + new URLSearchParams(data) : '');
            const headers = {
                'X-Bmob-Application-Id': APP_ID,
                'X-Bmob-REST-API-Key': REST_KEY
            };
            if (method === 'POST') headers['Content-Type'] = 'application/json';
            const options = { method: method, headers: headers };
            if (method === 'POST') options.body = JSON.stringify(data);

            try {
                const res = await fetch(url, options);
                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`Code ${res.status}: ${errText}`);
                }
                return await res.json();
            } catch (e) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${e.message}`, true);
                throw e;
            }
        }

        const ALLOWED_NAMES = ['å‰å‰', 'å°æ±Ÿ', 'è®¿å®¢'];
        let currentUser = "";

        window.onload = function() {
            log("æ­£åœ¨æµ‹è¯•è¿æ¥...");
            callBmob('GET', 'Leaderboard', { limit: 1 }).then(() => {
                log("âœ… è¿æ¥æˆåŠŸï¼");
                document.getElementById('networkTip').innerHTML = "<span style='color:green'>âœ… ç½‘ç»œé€šç•…ï¼Œå‡†å¤‡å‘è´¢</span>";
            }).catch(e => {
                document.getElementById('networkTip').innerHTML = "<span style='color:red'>âš ï¸ ç½‘ç»œä¸ç»™åŠ›</span>";
            });
        }

        function checkLogin() {
            const name = document.getElementById('userNameInput').value.trim();
            if (ALLOWED_NAMES.includes(name)) {
                currentUser = name;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('welcomeText').innerText = `ğŸ´ ${currentUser}ï¼Œæ–°å¹´å¿«ä¹ï¼`;
                fetchData();
            } else {
                alert("åå­—ä¸å¯¹å“¦ï¼Œæ˜¯ä¸æ˜¯è¾“é”™äº†ï¼Ÿ");
            }
        }

        function fetchData() {
            const today = new Date().toLocaleDateString();
            const params = { where: JSON.stringify({ "dateKey": today }), order: "-createdAt" };
            callBmob('GET', 'Leaderboard', params).then(res => {
                const list = res.results || [];
                renderList(list);
                const my = list.find(i => i.name === currentUser);
                document.getElementById('todayStatus').innerText = my ? `ä»Šæ—¥å·²ä¸­: ${my.prize}` : "ä»Šæ—¥å¥½è¿è¿˜æ²¡ç”¨æ‰";
            });
        }

        function renderList(list) {
            const box = document.getElementById('rankList');
            if(!list.length) { box.innerText = "ä»Šæ—¥æ¦œå•è™šä½ä»¥å¾…ï¼Œå¿«æ¥æ‹¿ç¬¬ä¸€ï¼"; return; }
            box.innerHTML = list.map((item, i) => `
                <div class="rank-item">
                    <span>${i+1}. ${item.name}</span>
                    <span style="color:#e74c3c;font-weight:bold">${item.prize}</span>
                </div>
            `).join('');
        }

        function uploadScore(prize) {
            if(prize.includes("å†æ¥") || prize.includes("æ–°å¹´")) return; // è¿™äº›ä¸ä¸Šä¼ 
            
            const today = new Date().toLocaleDateString();
            callBmob('GET', 'Leaderboard', { where: JSON.stringify({ "dateKey": today, "name": currentUser }) }).then(res => {
                if (res.results && res.results.length > 0) {
                    document.getElementById('uploadTip').innerText = "ä»Šæ—¥å·²è®°å½•ï¼Œä¸å†é‡å¤ä¸Šä¼ ";
                } else {
                    callBmob('POST', 'Leaderboard', {
                        name: currentUser, prize: prize, dateKey: today, timeStr: new Date().toLocaleTimeString()
                    }).then(() => {
                        document.getElementById('uploadTip').innerText = "æˆ˜ç»©å·²åŒæ­¥äº‘ç«¯";
                        fetchData();
                    });
                }
            });
        }

        // --- 2. æ¦‚ç‡ä¸å¥–å“é€»è¾‘è°ƒæ•´ ---
        // weight: å†³å®šä¸­å¥–æ¦‚ç‡ (æ•°å­¦)
        // drawWeight: å†³å®šæ‰‡å½¢å¤§å° (è§†è§‰) -> è§£å†³äº†å¤§å¥–çœ‹ä¸è§çš„é—®é¢˜
        const prizes = [
            // --- å¤§å¥–åŒº (æ•°å­¦æ¦‚ç‡ä½ï¼Œä½†è§†è§‰é¢ç§¯è®¾ä¸º 1ï¼Œæ¸…æ™°å¯è§) ---
            { name: "888å…ƒï¼", weight: 8, drawWeight: 0.6, color: "#d35400", txtColor: "#fff" },    // 0.08%
            { name: "666å…ƒï¼", weight: 60, drawWeight: 0.6, color: "#e67e22", txtColor: "#fff" },   // 0.6%
            
            // --- ç°é‡‘åŒº (é¢ç§¯æ­£å¸¸) ---
            { name: "å¥–é‡‘200", weight: 150, drawWeight: 0.8, color: "#f1c40f", txtColor: "#c0392b" }, 
            { name: "å¥–é‡‘100", weight: 200, drawWeight: 0.9, color: "#f39c12", txtColor: "#c0392b" }, 
            { name: "å¥–é‡‘50", weight: 625, drawWeight: 1, color: "#e74c3c", txtColor: "#fff" }, 
            { name: "å¥–é‡‘30", weight: 975, drawWeight: 1, color: "#c0392b", txtColor: "#fff" }, 
            { name: "å¥–é‡‘5å…ƒ", weight: 2250, drawWeight: 1.2, color: "#ecf0f1", txtColor: "#333" },   

            // --- æ°›å›´åŒº (drawWeight è®¾ä¸º 1.2ï¼Œç¨å¾®å¤§ä¸€ç‚¹ç‚¹ï¼Œç¬¦åˆ"é’±å°‘çš„ç¨å¾®å¤§ç‚¹") ---
            { name: "äº²ä¸€å£", weight: 2000, drawWeight: 1.3, color: "#fd79a8", txtColor: "#fff" }, 
            { name: "å†æ¥ä¸€æ¬¡", weight: 1500, drawWeight: 1.3, color: "#74b9ff", txtColor: "#fff" },
            { name: "æ–°å¹´å¿«ä¹", weight: 2232, drawWeight: 1.3, color: "#fab1a0", txtColor: "#d63031" } 
        ];

        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        
        // è®¡ç®—æ¦‚ç‡æ€»é‡
        const totalProbabilityWeight = prizes.reduce((s, p) => s + p.weight, 0); // 10000
        // è®¡ç®—è§†è§‰æ€»é‡
        const totalDrawWeight = prizes.reduce((s, p) => s + p.drawWeight, 0); 

        let rotation = 0;

        function draw() {
            const R = canvas.width / 2;
            let start = -Math.PI/2;
            
            prizes.forEach(p => {
                // ä½¿ç”¨ drawWeight (è§†è§‰æƒé‡) æ¥ç”»å›¾
                const angle = (p.drawWeight / totalDrawWeight) * 2 * Math.PI;
                
                ctx.beginPath(); ctx.moveTo(R,R); ctx.arc(R,R,R,start,start+angle);
                ctx.fillStyle = p.color; ctx.fill(); 
                ctx.lineWidth = 2; ctx.strokeStyle = "#fff"; ctx.stroke();
                
                ctx.save(); ctx.translate(R,R); ctx.rotate(start+angle/2);
                ctx.textAlign="right"; 
                ctx.fillStyle = p.txtColor || "#fff"; 
                ctx.font="bold 36px Arial"; 
                ctx.fillText(p.name, R-30, 10); 
                ctx.restore();
                start += angle;
            });
        }
        draw();

        function startSpin() {
            const btn = document.getElementById('spinBtn');
            if(btn.disabled) return;
            btn.disabled = true;
            btn.innerText = "å¥½è¿æµè½¬ä¸­...";
            
            // 1. æŠ½å¥–é€»è¾‘ï¼šä½¿ç”¨ weight (æ•°å­¦æ¦‚ç‡)
            const rand = Math.random() * totalProbabilityWeight;
            let sum = 0, target = prizes[0];
            for(let p of prizes) { sum += p.weight; if(rand <= sum) { target = p; break; } }
            
            // 2. æ—‹è½¬è§’åº¦è®¡ç®—ï¼šä½¿ç”¨ drawWeight (è§†è§‰ä½ç½®)
            // å¿…é¡»è®¡ç®—è¯¥å¥–é¡¹åœ¨è§†è§‰ä¸Šçš„è§’åº¦ä½ç½®
            let prevDrawSum = 0;
            for(let p of prizes) { if(p===target) break; prevDrawSum += p.drawWeight; }
            
            // è®¡ç®—ç›®æ ‡ä¸­å¿ƒç‚¹çš„è§’åº¦
            const targetAngle = (prevDrawSum + target.drawWeight/2) / totalDrawWeight * 360;
            
            const dist = 360*6 + (360 - targetAngle) - (rotation%360); // è½¬6åœˆ
            rotation += dist;
            
            canvas.style.transform = `rotate(${rotation}deg)`;
            canvas.style.transition = "transform 5s cubic-bezier(0.2,0.8,0.1,1)"; 

            setTimeout(() => {
                document.getElementById('prizeText').innerText = target.name;
                document.getElementById('modalOverlay').classList.add('active');
                
                // 3. è§¦å‘æ’’èŠ±åŠ¨ç”»
                fireConfetti();
                
                uploadScore(target.name);
                btn.innerText = "ç«‹å³è½¬è¿";
            }, 5000);
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('spinBtn').disabled = false;
        }

        // --- ç®€å•æ’’èŠ±ç‰¹æ•ˆ ---
        function fireConfetti() {
            const colors = ['#f1c40f', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6'];
            for(let i=0; i<50; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.background = colors[Math.floor(Math.random()*colors.length)];
                c.style.left = Math.random()*100 + 'vw';
                c.style.top = -10 + 'px';
                c.style.animationDuration = (Math.random()*2 + 1) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }
        }
    </script>
</body>
</html>